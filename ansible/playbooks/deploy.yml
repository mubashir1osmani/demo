# Deploy all k8s manifests and Helm charts to the GPU lab k3s cluster
# Usage: ansible-playbook -i inventory.ini playbooks/deploy.yml
---
- name: Deploy AI Lab to k3s
  hosts: gpu-lab
  become: true

  vars:
    k8s_dir: /tmp/k8s-manifests
    kubeconfig: /etc/rancher/k3s/k3s.yaml

  environment:
    KUBECONFIG: "{{ kubeconfig }}"

  tasks:
    # --- Sync manifests ---
    - name: Sync k8s manifests to server
      ansible.builtin.synchronize:
        src: "{{ playbook_dir }}/../../k8s/"
        dest: "{{ k8s_dir }}/"
        delete: true

    - name: Sync LiteLLM config
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../gateway/litellm-config.yml"
        dest: "{{ k8s_dir }}/litellm-config.yml"

    # --- Namespace ---
    - name: Create ai-lab namespace
      ansible.builtin.command:
        cmd: kubectl apply -f {{ k8s_dir }}/namespace.yml

    # --- Helm repos ---
    - name: Add ingress-nginx Helm repo
      ansible.builtin.command:
        cmd: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      register: helm_add
      changed_when: "'has been added' in helm_add.stdout"
      failed_when: false

    # - name: Add prometheus-community Helm repo
    #   ansible.builtin.command:
    #     cmd: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    #   register: helm_add_prom
    #   changed_when: "'has been added' in helm_add_prom.stdout"
    #   failed_when: false

    - name: Update Helm repos
      ansible.builtin.command:
        cmd: helm repo update

    # --- Nginx Ingress ---
    - name: Install/upgrade Nginx Ingress Controller
      ansible.builtin.command:
        cmd: >
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx
          --namespace ingress-nginx --create-namespace
          -f {{ k8s_dir }}/ingress/nginx-values.yml

    # --- NVIDIA device plugin ---
    - name: Install NVIDIA device plugin
      ansible.builtin.command:
        cmd: >
          kubectl apply -f
          https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.17.0/deployments/static/nvidia-device-plugin.yml

    # --- LiteLLM ConfigMap from actual config file ---
    - name: Create LiteLLM ConfigMap from config file
      ansible.builtin.command:
        cmd: >
          kubectl create configmap litellm-config
          --namespace ai-lab
          --from-file=config.yml={{ k8s_dir }}/litellm-config.yml
          --dry-run=client -o yaml
      register: configmap_yaml

    - name: Apply LiteLLM ConfigMap
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ configmap_yaml.stdout }}"

    # --- Deploy services ---
    - name: Deploy PostgreSQL
      ansible.builtin.command:
        cmd: kubectl apply -f {{ k8s_dir }}/postgres/

    - name: Deploy LiteLLM
      ansible.builtin.command:
        cmd: kubectl apply -f {{ k8s_dir }}/litellm/

    # - name: Deploy Open WebUI
    #   ansible.builtin.command:
    #     cmd: kubectl apply -f {{ k8s_dir }}/openwebui/

    # - name: Deploy Ollama
    #   ansible.builtin.command:
    #     cmd: kubectl apply -f {{ k8s_dir }}/ollama/

    # - name: Deploy vLLM
    #   ansible.builtin.command:
    #     cmd: kubectl apply -f {{ k8s_dir }}/vllm/

    # - name: Deploy Neo4j
    #   ansible.builtin.command:
    #     cmd: kubectl apply -f {{ k8s_dir }}/neo4j/

    # - name: Deploy SearXNG
    #   ansible.builtin.command:
    #     cmd: kubectl apply -f {{ k8s_dir }}/searxng/

    # - name: Deploy Phoenix (observability)
    #   ansible.builtin.command:
    #     cmd: kubectl apply -f {{ k8s_dir }}/monitoring/phoenix.yml

    # # --- Prometheus stack ---
    # - name: Install/upgrade Prometheus stack
    #   ansible.builtin.command:
    #     cmd: >
    #       helm upgrade --install prometheus prometheus-community/kube-prometheus-stack
    #       --namespace monitoring --create-namespace
    #       -f {{ k8s_dir }}/monitoring/prometheus-values.yml

    # --- Verify ---
    - name: Wait for pods to be ready
      ansible.builtin.command:
        cmd: kubectl get pods -n ai-lab -o wide
      register: pods_status

    - name: Show pod status
      ansible.builtin.debug:
        var: pods_status.stdout_lines
