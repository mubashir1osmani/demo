# Create k8s secrets from local .env file
# Usage: ansible-playbook -i inventory.ini playbooks/secrets.yml
#
# Expects a .env file at the repo root with these keys:
#   LITELLM_MASTER_KEY, ANTHROPIC_API_KEY, OPENAI_API_KEY, GEMINI_API_KEY,
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AZURE_API_KEY, AZURE_API_BASE,
#   XAI_API_KEY, TOGETHER_API_KEY, POSTGRES_USER, POSTGRES_PASSWORD,
#   NEO4J_AUTH, WEBUI_SECRET_KEY
---
- name: Create k8s secrets for AI Lab
  hosts: gpu-lab
  become: true

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  vars_files:
    - "{{ playbook_dir }}/../../.env"

  vars:
    # Fallback defaults (override via .env or --extra-vars)
    postgres_user: "{{ lookup('env', 'POSTGRES_USER') | default('litellm', true) }}"
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') | default('changeme', true) }}"
    neo4j_auth: "{{ lookup('env', 'NEO4J_AUTH') | default('neo4j/changeme', true) }}"
    webui_secret_key: "{{ lookup('env', 'WEBUI_SECRET_KEY') | default('changeme', true) }}"

  tasks:
    - name: Ensure ai-lab namespace exists
      ansible.builtin.command:
        cmd: kubectl create namespace ai-lab --dry-run=client -o yaml
      register: ns_yaml

    - name: Apply namespace
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ ns_yaml.stdout }}"

    - name: Create postgres-creds secret
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic postgres-creds
          --namespace ai-lab
          --from-literal=username={{ postgres_user }}
          --from-literal=password={{ postgres_password }}
          --dry-run=client -o yaml
      register: pg_secret

    - name: Apply postgres-creds secret
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ pg_secret.stdout }}"

    - name: Create litellm-secrets
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic litellm-secrets
          --namespace ai-lab
          --from-literal=master-key={{ lookup('env', 'LITELLM_MASTER_KEY') }}
          --from-literal=anthropic-api-key={{ lookup('env', 'ANTHROPIC_API_KEY') }}
          --from-literal=openai-api-key={{ lookup('env', 'OPENAI_API_KEY') }}
          --from-literal=gemini-api-key={{ lookup('env', 'GEMINI_API_KEY') }}
          --from-literal=aws-access-key-id={{ lookup('env', 'AWS_ACCESS_KEY_ID') }}
          --from-literal=aws-secret-access-key={{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}
          --from-literal=azure-api-key={{ lookup('env', 'AZURE_API_KEY') }}
          --from-literal=azure-api-base={{ lookup('env', 'AZURE_API_BASE') }}
          --from-literal=xai-api-key={{ lookup('env', 'XAI_API_KEY') }}
          --from-literal=together-api-key={{ lookup('env', 'TOGETHER_API_KEY') }}
          --from-literal=hf-token={{ lookup('env', 'HF_TOKEN') | default('', true) }}
          --dry-run=client -o yaml
      register: litellm_secret

    - name: Apply litellm-secrets
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ litellm_secret.stdout }}"

    - name: Create neo4j-creds secret
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic neo4j-creds
          --namespace ai-lab
          --from-literal=auth={{ neo4j_auth }}
          --dry-run=client -o yaml
      register: neo4j_secret

    - name: Apply neo4j-creds secret
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ neo4j_secret.stdout }}"

    - name: Create openwebui-secrets
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic openwebui-secrets
          --namespace ai-lab
          --from-literal=secret-key={{ webui_secret_key }}
          --dry-run=client -o yaml
      register: webui_secret

    - name: Apply openwebui-secrets
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ webui_secret.stdout }}"

    - name: Verify secrets
      ansible.builtin.command:
        cmd: kubectl get secrets -n ai-lab
      register: secrets_list

    - name: Show secrets
      ansible.builtin.debug:
        var: secrets_list.stdout_lines
