# Create k8s secrets from HashiCorp Vault
# Usage: ansible-playbook -i inventory.ini playbooks/secrets.yml
#
# Prerequisites:
#   - pip install hvac (or: ansible-galaxy collection install community.hashi_vault)
#   - Export VAULT_ADDR and VAULT_TOKEN, or pass as --extra-vars
#
# Expected Vault paths (KV v2):
#   secret/ai-lab/litellm    → master-key, anthropic-api-key, openai-api-key,
#                               gemini-api-key, aws-access-key-id, aws-secret-access-key,
#                               azure-api-key, azure-api-base, xai-api-key,
#                               together-api-key, hf-token
#   secret/ai-lab/postgres   → username, password
#   secret/ai-lab/neo4j      → auth
#   secret/ai-lab/openwebui  → secret-key
---
- name: Create k8s secrets from HashiCorp Vault
  hosts: gpu-lab
  become: true

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  vars:
    vault_addr: "{{ lookup('env', 'VAULT_ADDR') }}"
    vault_token: "{{ lookup('env', 'VAULT_TOKEN') }}"
    vault_mount: "secret"

    # Pull each secret path from Vault (KV v2)
    litellm_vault: "{{ lookup('community.hashi_vault.hashi_vault',
      'secret/data/ai-lab/litellm',
      url=vault_addr,
      token=vault_token) }}"
    postgres_vault: "{{ lookup('community.hashi_vault.hashi_vault',
      'secret/data/ai-lab/postgres',
      url=vault_addr,
      token=vault_token) }}"
    neo4j_vault: "{{ lookup('community.hashi_vault.hashi_vault',
      'secret/data/ai-lab/neo4j',
      url=vault_addr,
      token=vault_token) }}"
    openwebui_vault: "{{ lookup('community.hashi_vault.hashi_vault',
      'secret/data/ai-lab/openwebui',
      url=vault_addr,
      token=vault_token) }}"

  tasks:
    - name: Ensure ai-lab namespace exists
      ansible.builtin.command:
        cmd: kubectl create namespace ai-lab --dry-run=client -o yaml
      register: ns_yaml

    - name: Apply namespace
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ ns_yaml.stdout }}"

    - name: Create postgres-creds secret
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic postgres-creds
          --namespace ai-lab
          --from-literal=username={{ postgres_vault.username }}
          --from-literal=password={{ postgres_vault.password }}
          --dry-run=client -o yaml
      register: pg_secret

    - name: Apply postgres-creds secret
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ pg_secret.stdout }}"

    - name: Create litellm-secrets
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic litellm-secrets
          --namespace ai-lab
          --from-literal=master-key={{ litellm_vault['master-key'] }}
          --from-literal=anthropic-api-key={{ litellm_vault['anthropic-api-key'] }}
          --from-literal=openai-api-key={{ litellm_vault['openai-api-key'] }}
          --from-literal=gemini-api-key={{ litellm_vault['gemini-api-key'] }}
          --from-literal=aws-access-key-id={{ litellm_vault['aws-access-key-id'] }}
          --from-literal=aws-secret-access-key={{ litellm_vault['aws-secret-access-key'] }}
          --from-literal=azure-api-key={{ litellm_vault['azure-api-key'] }}
          --from-literal=azure-api-base={{ litellm_vault['azure-api-base'] }}
          --from-literal=xai-api-key={{ litellm_vault['xai-api-key'] }}
          --from-literal=together-api-key={{ litellm_vault['together-api-key'] }}
          --from-literal=hf-token={{ litellm_vault['hf-token'] | default('', true) }}
          --dry-run=client -o yaml
      register: litellm_secret

    - name: Apply litellm-secrets
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ litellm_secret.stdout }}"

    - name: Create neo4j-creds secret
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic neo4j-creds
          --namespace ai-lab
          --from-literal=auth={{ neo4j_vault.auth }}
          --dry-run=client -o yaml
      register: neo4j_secret

    - name: Apply neo4j-creds secret
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ neo4j_secret.stdout }}"

    - name: Create openwebui-secrets
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic openwebui-secrets
          --namespace ai-lab
          --from-literal=secret-key={{ openwebui_vault['secret-key'] }}
          --dry-run=client -o yaml
      register: webui_secret

    - name: Apply openwebui-secrets
      ansible.builtin.command:
        cmd: kubectl apply -f -
        stdin: "{{ webui_secret.stdout }}"

    - name: Verify secrets
      ansible.builtin.command:
        cmd: kubectl get secrets -n ai-lab
      register: secrets_list

    - name: Show secrets
      ansible.builtin.debug:
        var: secrets_list.stdout_lines
