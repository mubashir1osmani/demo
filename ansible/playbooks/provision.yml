# Provision the GPU droplet: sync NixOS config and rebuild
# Usage: ansible-playbook -i inventory.ini playbooks/provision.yml
---
- name: Provision NixOS GPU Lab
  hosts: gpu-lab
  become: true

  vars:
    nix_config_dir: /etc/nixos

  tasks:
    - name: Ensure NixOS config directory exists
      ansible.builtin.file:
        path: "{{ nix_config_dir }}"
        state: directory
        mode: "0755"

    - name: Sync NixOS flake configuration
      ansible.builtin.synchronize:
        src: "{{ playbook_dir }}/../../nix/"
        dest: "{{ nix_config_dir }}/"
        delete: true
        rsync_opts:
          - "--exclude=.git"

    - name: Write Tailscale auth key (if provided)
      ansible.builtin.copy:
        content: "{{ tailscale_auth_key }}"
        dest: /var/lib/tailscale/authkey
        mode: "0600"
      when: tailscale_auth_key is defined

    - name: Rebuild NixOS
      ansible.builtin.command:
        cmd: nixos-rebuild switch --flake {{ nix_config_dir }}#gpu-lab
      register: rebuild_result
      changed_when: "'activating the configuration' in rebuild_result.stderr"

    - name: Show rebuild output
      ansible.builtin.debug:
        var: rebuild_result.stderr_lines
      when: rebuild_result is defined
